このファイルは、Codex cli（codex） がこのリポジトリ内のコードを扱う際のガイドラインを示します。

---

## プロジェクト概要

GameMacroAssistant は PC ゲーム向けのデスクトップ自動化ツールであり、マウスやキーボードの操作を記録・編集・再生できます。
本ツールは画面認識を利用して、アクションを実行する前に画面状態を一致させます。

---

## コアアーキテクチャ

要件定義に基づき、本アプリケーションは以下を実装すべきです：

### 記録システム

* マウスおよびキーボード操作のグローバル入力キャプチャ
* ネイティブ解像度対応の画面キャプチャ（失敗時は GDI フォールバック）
* ESC キーによる記録セッション終了
* キャプチャ失敗時のエラーハンドリング（`Err-CAP` コードをログ出力）

### ビジュアルエディタ

* ブロックベースのマクロ表現（ドラッグ＆ドロップで並べ替え可能）
* 条件スクリーンショットの画像編集（ダブルクリックで編集、矩形選択）
* アンドゥ／リドゥ対応（Ctrl+Z）

### 実行エンジン

* グローバルホットキーによるトリガー（例：Ctrl+Shift+F10）
* 条件付き実行のための画像マッチング
* タイムアウト処理と通知システム（`Err-TMO` コードをログ出力）
* システムトレイでの進捗表示

### ファイル管理

* パスワード保護付きの暗号化 `.gma.json` ファイル形式（8文字以上）
* 最大3回のパスワード検証とエラーフィードバック

---

## 主要な技術要件

* **画面キャプチャ**: フルスクリーンゲーム対応、失敗時は GDI フォールバック
* **画像認識**: 保存条件と現在画面のマッチング
* **グローバルフック**: システム全体の入力キャプチャとホットキー登録
* **暗号化**: パスワード保護による安全なマクロファイル保存
* **エラーログ**: `Err-CAP`, `Err-TMO` などのエラーコード付き包括的ログ
* **UI フレームワーク**: ドラッグ＆ドロップ、画像編集、ブロック操作に対応するビジュアルエディタ

---

## 開発ノート

* 現在のプロジェクトには要件定義のみが含まれる
* 実装は「防御的な自動化（ゲーム補助）」に注力し、「不正利用的な自動化」は避ける
* ゲーム自動化のリアルタイム性から、エラーハンドリングとユーザーフィードバックは極めて重要
* 画面キャプチャ手法はクロスプラットフォーム互換性を考慮すること

---

## Codex cli における制約

* **重要**: Codex cli はセッション中にディレクトリを変更できない。`cd` コマンドを使用するとエラーになる
* すべてのファイル操作は現在の作業ディレクトリからの絶対パスを使用すること
* ディレクトリ依存操作が必要な場合は `Bash` を使う。ただし作業ディレクトリ変更は避けること

---

## 仮想環境（.venv）運用ポリシー

以後の開発・テスト・Lint は、原則としてリポジトリ直下の仮想環境（`.venv`）内で実行する。

- 必須: グローバル環境への `pip` インストールは禁止（`--user` や `--break-system-packages` は使用しない）
- 原則: コマンドは毎回 `.venv` のバイナリをフルパスで呼び出す（Codex CLI はセッションをまたぐ `source` が永続しないため）
- 例外: CI（GitHub Actions）はジョブが隔離されているため、システム環境に直接インストールしてよい（既存の `.github/workflows/ci.yml` 構成に準拠）

### セットアップ手順（Linux）

```bash
# 事前に必要になる場合（Debian/Ubuntu 系）
sudo apt-get update
sudo apt-get install -y python3-venv python3-pip python3-tk xvfb

# 仮想環境の作成と依存インストール
python3 -m venv .venv
./.venv/bin/python -m pip install -U pip
./.venv/bin/pip install -r requirements.txt
```

### 実行例（常に .venv を利用）

```bash
# Ruff（Lint/Format チェック）
./.venv/bin/ruff check .
./.venv/bin/ruff format . --check

# テスト（GUI 環境あり）
./.venv/bin/python -m pytest -q

# テスト（ヘッドレス/Wayland 回避、Xvfb 経由）
xvfb-run -a ./.venv/bin/python -m pytest -q
```

注意:
- Codex CLI は `source .venv/bin/activate` の効果が継続しないため、各コマンドで `./.venv/bin/...` を明示すること。
- Wayland 環境では `ImageGrab` やグローバル入力フックが制約を受ける可能性があるため、必要に応じて `xvfb-run` を使用すること（README のガイダンスに準拠）。

---

## Issue 完了ワークフロー

ユーザーが「実装完了」と報告した際の標準手順：

1. **Issue の確認とクローズ**

   ```bash
   gh issue view {issue_number} --json state,title
   gh issue close {issue_number} --comment "実装が完了しました。すべての受け入れ基準を満たしています。"
   ```

2. **ブランチを main にマージ**

   ```bash
   git merge feat/feature-name
   ```

3. **Epic Issue の更新**

   ```bash
   gh issue edit {epic_issue_number} --body "$(cat <<'EOF'
   [進捗を更新。完了項目には [x] を付与]
   EOF
   )"
   ```

4. **最終確認**

   ```bash
   git log --oneline -3
   gh issue view {epic_issue_number}
   ```

---

## 完了の定義（Definition of Done）

タスクが完了と見なされるのは以下条件を満たした場合のみ：

* **すべてのテスト成功**（例: `pytest`）
* **Ruff のリンター・フォーマッターに通過**（例: `ruff check .`, `ruff format . --check`）

これらはすべて終了コード 0 で終了しなければならない。

---

## 制約の追記

* **出力はすべて日本語で行うこと**。
  Codex cli が生成する説明、コードコメント、ログメッセージ、Issue コメント、ドキュメントはすべて日本語で記述すること。


