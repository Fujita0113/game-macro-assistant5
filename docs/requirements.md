***

# GameMacroAssistant：要件定義書 (Kiro/Gherkinスタイル)

## 概要

このドキュメントは、PCゲーム操作の自動化を目的としたマクロツール「GameMacroAssistant」の機能要件を定義します。ユーザーはマウスやキーボードの操作を記録・編集し、ホットキー一つで再生できます。

## 1. 機能: マクロの記録

### 1.1. ユーザーストーリー

**As a** ゲームプレイヤー, **I want** 自分のマウスやキーボードの操作をそのまま記録できる機能, **so that** ゲーム内の繰り返し作業を自動化したい。

### 1.2. シナリオ: マクロの記録を開始・終了する

**Scenario:** ユーザーが正常に一連の操作を記録する
**GIVEN** ユーザーがアプリケーションのメインウィンドウを開いている
**WHEN** ユーザーが「記録開始」ボタンをクリックする
**AND** ユーザーが一連のマウス操作とキーボード入力を行う
**AND** ユーザーが`ESC`キーを押す
**THEN** マクロの記録が終了する
**AND** 記録された操作がブロックとして配置された「ビジュアルエディタ」画面が自動的に開く

### 1.3. シナリオ: フルスクリーンゲームの操作を記録する

**Scenario:** ユーザーがフルスクリーンモードのゲームを記録する
**GIVEN** フルスクリーンでゲームが実行中である
**WHEN** ユーザーがマクロの記録を開始し、ゲーム内で操作を行う
**THEN** ゲーム画面のネイティブ解像度でスクリーンショットが取得される
**AND** スクリーンショット取得に失敗した場合、システムは代替方式（GDI）でキャプチャを試みる
**AND** 代替方式が使われた場合、取得した画像に「CaptureLimited」という半透明の透かしが表示される
**AND** アプリケーションログに`Err-CAP`というエラーコードが記録される

## 2. 機能: マクロの視覚的な編集

### 2.1. ユーザーストーリー

**As a** マクロ作成者, **I want** 記録した操作を、プログラミング不要のブロック形式で直感的に編集できる機能, **so that** 複雑な手順も簡単に調整・管理したい。

### 2.2. シナリオ: 操作の条件となる画像を編集する

**Scenario:** ユーザーがスクリーンショットから特定の部分をトリミングする
**GIVEN** ビジュアルエディタに、スクリーンショット付きの操作ブロックが表示されている
**WHEN** ユーザーがそのスクリーンショット画像をダブルクリックする
**THEN** 画像編集ツールが起動し、ユーザーはドラッグ操作で画像内の特定領域（例：ボタン）を矩形選択できる

### 2.3. シナリオ: 操作の順序を入れ替える

**Scenario:** ユーザーがブロックの順番をドラッグ＆ドロップで変更する
**GIVEN** ビジュアルエディタに複数の操作ブロックが表示されている
**WHEN** ユーザーが特定のブロックをドラッグし、別の位置にドロップする
**THEN** ブロックの順序が入れ替わる
**AND** ユーザーが`Ctrl+Z`キーを押すと、ブロックは元の位置に戻る

## 3. 機能: マクロの再生

### 3.1. ユーザーストーリー

**As a** ユーザー, **I want** 作成したマクロを、いつでも好きな時にホットキー一つで実行できる機能, **so that** 面倒な作業を即座に自動化したい。

### 3.2. シナリオ: マクロを正常に実行する

**Scenario:** ユーザーがホットキーでマクロを再生する
**GIVEN** ユーザーが編集済みのマクロを保存している
**WHEN** ユーザーが設定されたグローバルホットキー（例：`Ctrl+Shift+F10`）を押す
**THEN** マクロの再生が開始される
**AND** システムは現在のPC画面と、操作ブロックに設定された条件画像が一致するのを待つ
**AND** 画像が一致すると、関連付けられたマウス操作またはキーボード入力が実行される
**AND** タスクトレイのアイコンに進捗が表示される

### 3.3. シナリオ: マクロの実行がタイムアウトする

**Scenario:** 条件画像が見つからず、マクロが停止する
**GIVEN** マクロが再生中である
**AND** PC画面の状態が、次の操作ブロックの条件画像と一致しないまま設定時間が経過する
**WHEN** タイムアウト上限に達する
**THEN** マクロの再生が自動的に停止する
**AND** Windowsの通知センターにタイムアウトを示すエラーコード（`Err-TMO`）付きの通知が表示される
**AND** ログファイルに詳細なエラー情報が書き込まれる

## 4. 機能: プロジェクト管理とセキュリティ

### 4.1. ユーザーストーリー

**As a** ユーザー, **I want** 作成したマクロをファイルとして安全に保存・管理できる機能, **so that** 苦労して作ったマクロを失うことなく、後から再利用したい。

### 4.2. シナリオ: マクロを暗号化して保存する

**Scenario:** ユーザーが新規マクロをパスワード付きで保存する
**GIVEN** ビジュアルエディタでマクロの編集が完了している
**WHEN** ユーザーが「保存」ボタンをクリックする
**AND** ユーザーがファイル名を入力する
**AND** パスワード入力ダイアログが表示され、8桁以上のパスワードを入力する
**THEN** マクロが暗号化された`.gma.json`ファイルとしてPCに保存される

### 4.3. シナリオ: 暗号化されたマクロを読み込む

**Scenario:** ユーザーがパスワード付きのマクロファイルを開く
**GIVEN** ユーザーが「開く」ボタンから暗号化された`.gma.json`ファイルを選択する
**WHEN** パスワード入力ダイアログが表示され、ユーザーが正しいパスワードを入力する
**THEN** マクロの全ステップがビジュアルエディタに正常に読み込まれる

**Scenario:** ユーザーが誤ったパスワードでマクロファイルを開こうとする
**GIVEN** ユーザーが暗号化された`.gma.json`ファイルを開こうとしている
**WHEN** ユーザーが誤ったパスワードを3回入力する
**THEN** ファイルの読み込みがキャンセルされる
**AND** 画面に「パスワードが違います」というエラーメッセージが表示される